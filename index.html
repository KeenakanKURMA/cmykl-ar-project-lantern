<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Scanner</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.2.1/aframe/build/aframe-ar.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .permission-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            text-align: center;
            padding: 20px;
        }
        
        .permission-message.show {
            display: flex;
        }
        
        .retry-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .scanning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .scan-box {
            width: 200px;
            height: 200px;
            border: 2px solid rgba(76, 175, 80, 0.8);
            border-radius: 10px;
            position: relative;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #4CAF50;
            top: 0;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        
        .scan-text {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            text-align: center;
        }
        
        .marker-detected {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        a-scene {
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* Fix for mobile viewport */
        @media (max-width: 768px) {
            .scan-box {
                width: 180px;
                height: 180px;
            }
            
            .scan-text {
                font-size: 13px;
                padding: 0 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Initializing AR Scanner...</p>
    </div>
    
    <!-- Camera Permission Message -->
    <div class="permission-message" id="permissionMessage">
        <h2>Camera Access Required</h2>
        <p>This app needs camera access to scan AR markers</p>
        <p style="margin-top: 10px; font-size: 14px; opacity: 0.7;">Please allow camera permissions and refresh the page</p>
        <button class="retry-btn" onclick="retryCameraAccess()">Try Again</button>
    </div>
    
    <!-- Scanning Overlay -->
    <div class="scanning-overlay">
        <div class="scan-box">
            <div class="scan-line"></div>
        </div>
        <div class="scan-text">Point camera at AR marker<br>Ensure good lighting</div>
    </div>
    
    <!-- Marker Detected Message -->
    <div class="marker-detected" id="markerDetected">
        âœ“ Marker Detected
    </div>
    
    <!-- AR Scene -->
    <a-scene 
        embedded 
        arjs="
            sourceType: webcam; 
            debugUIEnabled: false; 
            detectionMode: mono_and_matrix; 
            matrixCodeType: 3x3;
            maxDetectionRate: 60;
            cameraParametersUrl: https://raw.githubusercontent.com/jeromeetienne/AR.js/master/data/data/camera_para.dat;
        "
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        stats
    >
        <!-- Lighting -->
        <a-entity light="type: ambient; color: #ffffff; intensity: 0.7"></a-entity>
        <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="2 5 3"></a-entity>

        <!-- Marker 1 - Hiro Pattern (Sphere) -->
        <a-marker 
            type="pattern" 
            url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.patt"
            emitevents="true" 
            id="marker-hiro"
            size="0.2"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
        >
            <a-sphere 
                position="0 0.5 0" 
                radius="0.3" 
                color="#FFD700"
                metalness="0.8"
                roughness="0.2"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
            ></a-sphere>
            <a-text 
                value="HIRO" 
                position="0 1 0" 
                align="center" 
                color="#FFFFFF"
                scale="2 2 2"
            ></a-text>
        </a-marker>

        <!-- Marker 2 - Kanji Pattern (Box) -->
        <a-marker 
            type="pattern" 
            url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/kanji.patt"
            emitevents="true" 
            id="marker-kanji"
            size="0.2"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
        >
            <a-box 
                position="0 0.5 0" 
                width="0.5" 
                height="0.5" 
                depth="0.5" 
                color="#FF4136"
                metalness="0.7"
                roughness="0.3"
                animation="property: rotation; to: 360 360 0; loop: true; dur: 5000"
            ></a-box>
            <a-text 
                value="KANJI" 
                position="0 1.2 0" 
                align="center" 
                color="#FFFFFF"
                scale="2 2 2"
            ></a-text>
        </a-marker>

        <!-- Marker 3 - Area Pattern (Cone) -->
        <a-marker 
            preset="area" 
            emitevents="true" 
            id="marker-area"
            size="0.2"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
        >
            <a-cone 
                position="0 0.5 0" 
                radius-bottom="0.3" 
                radius-top="0.1" 
                height="0.7" 
                color="#0074D9"
                metalness="0.6"
                roughness="0.4"
                animation="property: rotation; to: 0 0 360; loop: true; dur: 3000"
            ></a-cone>
            <a-text 
                value="AREA" 
                position="0 1.3 0" 
                align="center" 
                color="#FFFFFF"
                scale="2 2 2"
            ></a-text>
        </a-marker>

        <!-- Camera Entity with optimized settings -->
        <a-entity 
            camera 
            position="0 0 0"
            near="0.01"
            far="1000"
        ></a-entity>
    </a-scene>

    <script>
        // Elements
        const loading = document.getElementById('loading');
        const permissionMessage = document.getElementById('permissionMessage');
        const markerDetected = document.getElementById('markerDetected');
        const arScene = document.querySelector('a-scene');
        
        let markersDetected = 0;
        
        // Check camera permission
        async function checkCameraPermission() {
            try {
                // Try to get camera stream with optimal constraints
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // Stop the stream since AR.js will handle it
                stream.getTracks().forEach(track => track.stop());
                hideLoading();
                return true;
            } catch (err) {
                console.error('Camera error:', err);
                showPermissionMessage();
                return false;
            }
        }
        
        function hideLoading() {
            loading.style.opacity = '0';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 500);
        }
        
        function showPermissionMessage() {
            loading.style.display = 'none';
            permissionMessage.classList.add('show');
        }
        
        function hidePermissionMessage() {
            permissionMessage.classList.remove('show');
        }
        
        function showMarkerDetected(markerId) {
            markersDetected++;
            markerDetected.style.display = 'block';
            markerDetected.style.animation = 'none';
            void markerDetected.offsetWidth; // Trigger reflow
            markerDetected.style.animation = 'fadeInOut 3s ease-in-out';
            
            // Hide after animation
            setTimeout(() => {
                markerDetected.style.display = 'none';
            }, 3000);
        }
        
        function retryCameraAccess() {
            hidePermissionMessage();
            loading.style.display = 'flex';
            loading.style.opacity = '1';
            
            setTimeout(() => {
                checkCameraPermission();
            }, 500);
        }
        
        // Marker event listeners with better detection
        function setupMarkerEvents() {
            const markers = document.querySelectorAll('a-marker');
            
            markers.forEach(marker => {
                marker.addEventListener('markerFound', (event) => {
                    console.log('Marker found:', marker.id);
                    showMarkerDetected(marker.id);
                    
                    // Add visual feedback
                    marker.setAttribute('animation', {
                        property: 'scale',
                        to: '1.1 1.1 1.1',
                        dur: 300,
                        easing: 'easeOutElastic'
                    });
                });
                
                marker.addEventListener('markerLost', (event) => {
                    console.log('Marker lost:', marker.id);
                    
                    // Reset scale
                    marker.setAttribute('animation', {
                        property: 'scale',
                        to: '1 1 1',
                        dur: 300,
                        easing: 'easeOutElastic'
                    });
                });
            });
        }
        
        // Scene loaded event
        arScene.addEventListener('loaded', function() {
            console.log('AR Scene loaded');
            setupMarkerEvents();
            
            // Wait a bit then check camera
            setTimeout(() => {
                checkCameraPermission();
            }, 1500);
        });
        
        // Handle any scene errors
        arScene.addEventListener('error', function(e) {
            console.error('Scene error:', e);
            loading.innerHTML = '<p>Error loading AR. Please refresh the page.</p>';
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible again
                setTimeout(() => {
                    checkCameraPermission();
                }, 500);
            }
        });
        
        // Add resize handler for better mobile experience
        window.addEventListener('resize', function() {
            // Force AR.js to recalculate camera
            if (arScene.is('arjs')) {
                arScene.emit('resize');
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing AR...');
        });
    </script>
</body>
</html>
