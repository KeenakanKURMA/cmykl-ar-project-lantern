<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Scanner</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.2.1/aframe/build/aframe-ar.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .permission-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            text-align: center;
            padding: 20px;
        }
        
        .permission-message.show {
            display: flex;
        }
        
        .scanning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .scan-box {
            width: 250px;
            height: 250px;
            border: 2px solid rgba(76, 175, 80, 0.8);
            border-radius: 15px;
            position: relative;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #4CAF50;
            top: 0;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        
        .scan-text {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }
        
        .marker-detected {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1000;
        }
        
        .marker-detected.show {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        a-scene {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading AR Scanner...</p>
    </div>
    
    <!-- Camera Permission Message -->
    <div class="permission-message" id="permissionMessage">
        <h2>Camera Access Required</h2>
        <p>Please allow camera access to use AR Scanner</p>
        <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">Point camera at markers to see 3D objects</p>
    </div>
    
    <!-- Scanning Overlay -->
    <div class="scanning-overlay">
        <div class="scan-box">
            <div class="scan-line"></div>
        </div>
        <div class="scan-text">Point camera at AR marker</div>
    </div>
    
    <!-- Marker Detected Message -->
    <div class="marker-detected" id="markerDetected">
        Marker Detected
    </div>
    
    <!-- AR Scene -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
    >
        <!-- Lighting -->
        <a-entity light="type: ambient; color: #ffffff; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="1 1 1"></a-entity>

        <!-- Marker 1 - Sphere -->
        <a-marker 
            type="pattern" 
            url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.patt"
            emitevents="true" 
            id="marker1"
        >
            <a-sphere 
                position="0 0.5 0" 
                radius="0.3" 
                color="#FFD700"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
            ></a-sphere>
        </a-marker>

        <!-- Marker 2 - Box -->
        <a-marker 
            preset="hiro" 
            emitevents="true" 
            id="marker2"
        >
            <a-box 
                position="0 0.5 0" 
                scale="0.5 0.5 0.5" 
                color="#FF4136"
                animation="property: rotation; to: 360 360 0; loop: true; dur: 4000"
            ></a-box>
        </a-marker>

        <!-- Marker 3 - Cone -->
        <a-marker 
            type="pattern" 
            url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/kanji.patt"
            emitevents="true" 
            id="marker3"
        >
            <a-cone 
                position="0 0.5 0" 
                radius-bottom="0.3" 
                radius-top="0.1" 
                height="0.7" 
                color="#0074D9"
                animation="property: rotation; to: 0 0 360; loop: true; dur: 3000"
            ></a-cone>
        </a-marker>

        <!-- Camera -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Elements
        const loading = document.getElementById('loading');
        const permissionMessage = document.getElementById('permissionMessage');
        const markerDetected = document.getElementById('markerDetected');
        const arScene = document.querySelector('a-scene');
        
        // Check camera permission
        async function checkCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                // Stop the stream since AR.js will handle it
                stream.getTracks().forEach(track => track.stop());
                hideLoading();
                return true;
            } catch (err) {
                showPermissionMessage();
                return false;
            }
        }
        
        function hideLoading() {
            loading.style.opacity = '0';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 500);
        }
        
        function showPermissionMessage() {
            loading.style.display = 'none';
            permissionMessage.classList.add('show');
        }
        
        function showMarkerDetected() {
            markerDetected.classList.add('show');
            setTimeout(() => {
                markerDetected.classList.remove('show');
            }, 2000);
        }
        
        // Marker event listeners
        document.querySelectorAll('a-marker').forEach(marker => {
            marker.addEventListener('markerFound', () => {
                showMarkerDetected();
            });
        });
        
        // Scene loaded event
        arScene.addEventListener('loaded', function() {
            setTimeout(() => {
                checkCameraPermission();
            }, 1000);
        });
        
        // Retry camera access when clicking permission message
        permissionMessage.addEventListener('click', function() {
            permissionMessage.classList.remove('show');
            loading.style.display = 'flex';
            loading.style.opacity = '1';
            setTimeout(() => {
                checkCameraPermission();
            }, 1000);
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible again, check camera
                checkCameraPermission();
            }
        });
    </script>
</body>
</html>
